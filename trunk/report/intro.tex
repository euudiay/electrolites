\chapter{Intro}
\label{cha:intro}
	\section{Project description}

		This project exposes the research conducted for the development of an USB 802.15.4 receiver device for Android based systems employed in a fully functional ECG monitoring system encompassed in the field of personal healthcare, as well as the development process involved in the realization of this whole system.\\

		% What is Personal-healthcare, what is ECG Monitoring, importance of a lowcost ecg monitoring system

		% Tareas asumidas por el sistema para expresar el ambito del proyecto
		The system provides the user with a visual representation of his/her ECG wave highlighting relevant points of this in order to simplify its comprehension. Information about heart-beat-rate % and arrhitmia?
		is also displayed. All this data is stored in realtime in a transparent to the user manner for later visualization with emphasis put in easy handling of the generated files.\\

		\begin{comment}
		¿Qué es cada parte?
		Sistema 3 partes: nodo delineador, receptor 802.15.4 y app como frontend en general. En un parrafo distino para cada una explicar las tecnologías que hemos usado y porque. 

		¿Cómo se hizo cada parte?
		(Orden, android ->shimmer->msp430->dirigir texto hacia investigación(flecha = parrafo))
		Visualizador: Android ampliamente usado, facilidad para obtener un dispositivo, no demasiado coste (al menos < iOS), plataforma abierta, desarrollo comodo.
		Shimmer: reutiliza sistema desarrollado por la complu en colaboración con EPFL
		Receptor: 

		\end{comment}
		
		
		%As the title suggests, this projects aims for creating a system capable of receiving ECG signals from
		%patients and displaying them so that doctors or specialized staff can analyze them and possibly diagnose
		%heart-related illnesses.\\\\
		In order to do that, we have been using a system already developed which
		was responsible of monitoring the patient and sending the resulting data wirelessly as well. These
		devices were able to send their information through Bluetooth or using IEEE 802.15.4 standard, which
		is specially relevant for this project, as we will see later on in this document.\\
		Once the results of ECG analysis are emitted, it will be necessary to properly receive and parse them
		within the displaying device and, finally, show them so they will be human-readable.\\
		This displaying device acts as the system's user interface, and it provides
		functionality to visualize received data, change visualization parameters, and save and load
		already-parsed received data also. Thus, considering a monitoring device is sending data,
		a typical use of the system is: an user executes the developed application on the displaying
		device, then selects the monitoring device which ECG *he/she wants to analyze and the application % he/she? nada?
		starts to show the data as it is receiving it. Meanwhile, that information is being logged to 
		a file at the same time it is being displayed, storing it so as to allow its later, further
		analysis.\\
		In spite of the fact that the displaying application is needed because it allows the development of
		the rest of the project, it is not the main goal since key feature is represented by the 802.15.4
		communication. In other words, most efforts are focused in connecting and communicating emmiter and
		receiver devices, considering the development of the application as way to complete the system with 
		an useful purpose.\\
		Regarding the communications, it is also worth of remark that our target displaying device, Xoom tablet 
		from Motorola, incorporates the standard Bluetooth module, yet it is not equipped with a ZigBee one.
		Due to this lack, which is more than usual among portable devices nowadays, the making of a compatible 
		receiver accessory centers a fairly important part of the project.\\
		In short, the main objective for this project, seen as a whole system, consists of
		visually and wirelessly displaying and managing data obtained from portable, personal ECG-monitoring
		emitter devices on an Android tablet, paying special attention to make possible the communication
		with Android through 802.15.4. In order that the system can operate that way, the following 
		issues will have to be resolved:
		\begin{enumerate}
			\item \emph{Communication with 802.15.4 emitters}\\
				Android devices are usually equipped with Bluetooth radio modules, so it is likely that they 
				count with working Bluetooth communications out of the box, which is the case of the target
				device, a Motorola Xoom tablet.
				However, 802.15.4-compliant communication is not natively supported by any existing Android
				device --not even any other widely known portable computing device--, so it will be needed % which leads to the following goal for the project to fulfill. \\
				the development of an alternative method for achieving this goal. As the next item states,
				the solution to this problem consists of building up a receiver accessory capable of connecting
				to the tablet through USB interface. This particular task centers most of the efforts dedicated
				to the project, since it is both crucial for the proper operation of the system and unprecedent
				in its field, as it will be detailed later.
			\item \emph{Android accessory development}\\
				As it was stated before, Android-powered devices are usually equipped with Bluetooth radio
				modules, yet they lack the capability to communicate with devices which implements other 
				standards. In order to achieve this feature for this sort of device, development of an
				specifically designed accessory is both a required and mandatory task.\\
				The aforementioned support Android OS provides for USB device and host modes would allow us to
				obtain data processed by the accessory through an available interface for almost every 
				Android device. In particular, USB host mode would be required so that the Android device 
				were to be able to power the accessory, hence the restriction of using devices running
				Android version 3.1 or newer.\\
				For this goal an USB-capable board equipped with an MSP430 microcontroller was chosen for acting
				as the receiver accessory. More specifically, this microcontroller would be running FreeRTOS
				(operating system oriented to tasks with real-time needs), which would be accordingly modified
				for dealing with the USB interface and 802.15.4 communication.\\
				It is also noteworthy that the usage of a prototyping board and a potential miniaturisation of
				the previously described board were included into the scope of this objective as well. Besides, 
				full description and more details about this development and 802.15.4 communication can be found 
				at \autoref{ch:hardware}, \nameref{ch:hardware}.\\
			\item \emph{Android ECG application}\\
				Finally, an Android application acts as the system's frontend. Its most relevant requirements were
				determined by the existing EPFL iOS application, with subtle modifications due to the different
				platform as well as the inclusion of an extra accessory.\\
				The data the application displays, in the shape of ECG waves, may be retrieved from a Bluetooth
				or 802.15.4 streaming node or a local log file. These logs are written by the application itself
				as it receives an incoming data transmission, so that it can replay them later --original
				iOS application lacked this feature--.\\
				Moreover, view controls shall also be offered for the user to modify display density, and move
				forwards and backwards if a log is being displayed.\\
				More information about the application, such as requirements and other details, can be found
				at \autoref{ch:swdev}, \nameref{ch:swdev}.\\
		\end{enumerate}
		
	\section{Project driver}
		The main motivation for developing this project was the fact that it meant
		the gathering of almost every branch of this career. From its very beginning, this
		work involved both software and hardware development, researching on unknown 
		tools and platforms as well as high and low-level design and programming.\\
		Besides, if successful, it would be likely it could become a real product
		and be useful both in a professional and particular scope, which added a practical
		end for the work to be carried out. Something like this could be made thanks to
		the special features --such as less power consumption and required investment-- 802.15.4-compliant
		technologies provide which wider spread ones lack (Bluetooth, for instance). It is also
		expected that technologies based on IEEE 802.15.4 specification like ZigBee will increase their
		importance in the medium term due to their potential applications in domotics (home automation).\\
		In addition, not only developing applications for portable devices but accessories
		are mainstream nowadays; thus, getting in touch with these activities could
		provide us with extra experience at leading edge practices, what would broaden our areas of
		expertise and, consequently, increment our chances to access the labour market.\\
		However, certain areas of the project would mean working on unprecedent techniques
		--as it will be detailed later on within this section-- and dealing with tools
		which were unknown for us at that moment. Hitches like these could lead to the
		unfulfillment of the project, yet they could also add extra value to it if 
		they were overcome.\\
		
	\section{State of the art}
		\begin{itemize}


			%Añadir otro item de monitorizacion, onads P QRS y T etc etc. no solo EPFL si no en general, y luego ya EPFL concret
			\item \emph{EPFL Project}\\
				% Proyecto EPFL (pedir referencias a Fran)
				%\item Hace un año: estado de la comunicación android-usb y android-802.15.4 (conexión de dispositivos portátiles con sensores biométricos y no biométricos, costes, consumo, acho de banda, ...)
				% Proyecto ya existente (a nivel europeo, Lausanne, ...)
				% Aplicación ya desarrollada (dentro del mismo proyecto) para dispositivos iOS, en particular 
				% iPhone, en plan prototipo con grandes limitaciones, poco accesible (instalar manualmente 
				% stack bluetooth, implicando jailbreak), sólo por bluetooth, sin funcionalidad de lectura 
				% de logs. Dispositivos iOS alto coste.
				As a precedent of the present project, the École Polytechnique Fédérale de Lausanne (EPFL),
				along with the Complutense University of Madrid (UCM), developed a wireless ECG monitoring
				system, similar to the one has been built up during	this project.
				Just as ours, this system also used *Shimmers as monitoring, transmitter devices; % No sé si es el nombre técnico adecuado, y tampoco sé exactamente de qué es lo que no podemos hablar.
				and the obtained data could be displayed in portable computing devices.\\
				Nonetheless, the list of similarities ends there. The application responsible for rendering
				the ECG waves was meant to be used over iOS devices, particularly iPhone. This fact led to several
				additional restrictions, such as mandatory usage of Bluetooth as wireless transmission method as
				well as the need of ``jailbreaking'' the device itself. Jailbreak process was needed in order that
				a explicitly installed Bluetooth stack allowed the device to receive the emitted data properly.
				Therefore, the employment of Android in our project is partially motivated by this sort of
				limitations other platforms usually impose.\\
				*Our project collaborates with EPFL, from whom we have received feedback as well as hardware and % No me quedó claro quién colaboraba con quién, y cómo decir que la colaboración está mediada por "Fran".
				software requirements. In fact, the aforementioned iOS application *settled most of the
				requirements for the Android one in our project, although there were added some extra ones --such as
				making logs from received data so they can be read again later--.\\
			\item \emph{IEEE 802.15.4}\\
				This standard describes the physical and Media Access Control (MAC) layers for low-rate wireless
				personal area networks. It is intended to be implemented into embedded devices, so as to build up
				short-range networks --10 meters, tipically-- with narrow bandwith, up to 250kbps, among other
				possibilites with lower transfer rates.\\
				802.15.4 is specially suitable for this kind of project due to its low power consumption. In
				fact, ZigBee, which uses this standard as its low-level layer, presents a series of advantages
				over Bluetooth, underlying technology of the previously mentioned EPFL project:
				\begin{itemize}
					\item \textbf{Lower power consumption:} without going into detail, it can be stated that Bluetooth 
						requires more power than ZigBee does. For example, Bluetooth is constantly emitting information,
						consequently consuming power, while 802.15.4 allows to enable the radio only when it is needed.
						These statements are properly justified and explained at \autoref{ch:hardware}
					\item \textbf{Bandwidth:} Bluetooth offers much wider bandwidth, up to 3Mbps, meanwhile ZigBee 
						only offers up to 250kbps. This, however, is not a relevant disadvantage because our needs 
						are not so high.
					\item \textbf{Host number:} ZigBee allows to build networks with up to 65535 hosts, subnetworks 
						with 255 hosts. On the ohter hand, Bluetooth can only support as much as 8 hosts within a 
						network. 
				\end{itemize}
				ZigBee, though, is not employed as a whole within this project, but 802.15.4 standard as
				its basis. Nevertheless, its advantages over Bluetooth remains the same, with the additional one
				that it does not compromise soft real-time developments as the complete stack does.\\
			\item \emph{Android Accessory Development}\\
				As of May, 2011, there were no easy nor official methods to develop
				accessories capable of communicating with Android running devices. At that
				certain time, the release of the Android Open Accessory Development Kit (also known as ``ADK'')
				was announced in San Francisco, within the context of Google I/O, developers
				conference arranged by Google.\\
				ADK consists of an USB microcontroller board based on Arduino (Arduino Mega2560 to be precise) and a
				series of software libraries which add specific functionalities and support for other hardware add-ons,
				tipically known as \emph{shields}, that equip the accessory with sensors or interactive elements
				which broaden its capabilities. Shields are plugged to the board through its numerous input/output
				pins, which also allow the connection of personally crafted hardware additions --allowing that way to
				create tailored behaviours, following the Arduino's ``Do It Yourself'' (DIY) spirit.\\
				With the release of that kit, Android project opened itself to the development
				of all kind of new accessories which would add potential and functionalities
				it lacked.\\
				As well as this kit, the following release of Android 3.1 API version completed
				the accessory ecosystem with the inclusion of directly supported host and device
				USB modes --this support was also backported to Android v2.3.4; only the device mode, though--.
				By doing so, Google completely cleared the way for the development of Android-compatible accessories, 
				which was previously reduced to the underlying, quite complete but not enough, Linux kernel driver 
				support.\\
			\item \emph{ZigBee dongles}\\
				In spite of the fact that there were available devices which implemented the complete ZigBee
				stack at the time of the start of this project, they were only designed for being connected to
				personal computers, some models with OS restrictions as well.\\
				Moreover, even if they were to be compatible with our target device, the only available dongles
				fully implemented the ZigBee stack, which also made them unsuitable for this project due to the
				relatively high latency that fact imposed --as it can be read at \autoref{ch:hardware},
				\nameref{ch:hardware}, soft-realtime needs required the usage of the 802.15.4 MAC layer on
				its own--.
			\item \emph{Communication with Android using ZigBee}\\
				One year ago, around mid-2011, there were very few projects which were working on this sort of
				communication, between Android and 802.15.4 radio-equipped devices. Concretely, the only project
				of this kind we were aware of was one from Texas Instruments, which was stated to be pioneer in 
				this field (as it can be seen in \cite{articleTI}).
				Despite that, several differences stands between this project and ours. For instance:
				\begin{itemize}
					\item \textbf{USB communication:} Texas Instruments developed its own Android driver, namely
						``virtual COM port'', so they could directly connect their ZigBee Network Processor (ZNP)
						to the Android device through USB. Instead, Android USB host mode is used in this project
						in order to establish the connection between the receiver and the device. Because of
						using this method, USB communication between MSP430 microcontroller and the Android
						device has to be specifically implemented and tuned.
					\item \textbf{Android platform:} TI's project employed Android 2.2, while we are using
						version	3.1 in ours, due to the aforementioned need of USB host mode support this API
						provides. In addition, received data is used by our Android application, while TI
						employed ZigBee communication for less specific ends, such as controlling other devices
						like PCs, lamps or obtaining data from certain sensors.
					\item \textbf{Wireless communication:} in order that the ECG delineation could be done in
						real-time (namely soft real-time, as it will be explained later), this project does not
						use the complete ZigBee stack, but its 802.15.4 MAC layer. This restriction requires the
						radio --in particular, TI CC2420 radio module-- has to be programmed specifically.
						Meanwhile, Texas Instruments made use of its TI CC2530 system on chip (SoC), which fully 
						implemented ZigBee stack.
					\item \textbf{USB dongle:} as it was mentioned before, TI directly plugged their ZNP to an
						OMAP4 Blaze thanks to their driver. However, so that the same result could be obtained,
						we had to connect the radio, CC2420 module, to the MSP430 board --*nombre de la placa--,
						which was equipped with a USB interface. Furthermore, miniaturisation of this board was
						designed afterwards to make it an usable dongle.
				\end{itemize}
				In other words, Texas Instruments' project was actually able to build up working communications
				of this kind by the time ours was starting; all the same, special requirements like real time
				needs entail additional challenges for this project to overcome.
		\end{itemize}
	
	\section{Document overview}
		Over the following pages, this document will present the details about the project it refers to.
		Beginning with a deep description and analysis of the Android application's design and implementation,
		which can be found at the ``Software Development'' chapter; next, a thorough explanation about the
		employed hardware and the work it required; and, finally, an exposition of the obtained results,
		potential expansions and findings.  

		% Ideas Pool
		% ===========
		% En esta sección: Motivación y objetivos principales del proyecto
		

		% Objetivo: desarrollo de un receptor mac 802.15.4 (ZigBee) con conexión 
		% usb para dispositivos android y de una aplicación android para visualización 
		% de datos recibidos de ecg

		% Interesante porque engloba gran parte de lo aprendido en la carrera, habiendo 
		% que desarrollar el proyecto en casi todos los niveles de abstracción, desde diseño 
		% y miniaturización de placas hasta desarrollo basado en un framework de muy alto 
		% nivel como es Android, pasando por prototipado en placa(pasando por arduino) y 
		% desarrollo a nivel de microarquitecturas, en concreto FreeRTOs para procesadores MSP430.

		% Novedad en la comunicación USB entre Android y el MSP sin hardware intermedio, 
		% actuando el dispositivo Android de host para eliminar la fuente de alimentación del MSP, 
		% minimizando al máximo el coste del dispositivo de recepción
		
		% Interés en la utilización del stack ZigBee para maximizar la duración de la batería 
		% del shimmer (nodo delineador). e.g. enviando por bluetooth horas, enviando por shimmer días
		%		+ Una red zigbee es mucho más barata (y factible) que una bluetooth. Repetidores zigbee baratos.

		% Utilidad para el mundo real, que podría ser adoptada en hospitales dado que es 
		% algo que ya se ha estado probando en algunos hospitales y esto sería un importante 
		% impulso para el proyecto
		
		% Relacionado con la aplicación real en hospitales (o uso en domicilio particular) 
		% el reducido tamaño del nodo delineador permite gran portabilidad, incluso llevarlo 
		% encima con objeto de monitorización constante.
		
		% Cubre necesidad profesional, médico o enfermera monitorizando un grupo de pacientes 
		% de tamaño arbitrario con un único dispositivo android; o incluso a larga distancia 
		% recibiendo los datos por internet.
		
		% Desarrollando el uso particular, posible aplicación a particulares que posean dispositivos 
		% táctiles android, para automonitorización en enfermedades en que sea necesario.
