\chapter{Hardware and communications}
\label{ch:hardware}
	\section{Introduction}	

	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% ¡FALTA COMENTAR EN ALGUN SITIO QUE EL DESARROLLO SW SE REALIZA EN PARALELO! %
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


	%que necesidad cubre la parte hardware del proyecto

	% OLD: The hardware in our project cover a main need, an external device to be able to communicate our android device with a *shimmer through 802.15.4. Than device have to be a little and low powered device that can be conected as device through USB in an android device. Little, because a device that disturb a regular work is not valid at all. Low powered, because if the cost of power the divece is higher than use the stack bluetooth we lose an important adventage of use 802.15.4. Able to be coneced throught USB in our android device because this is the only way to interact with android for a external device. And finally able to be connected as device to elimminate the needed of an extra batery that would have incresed the cost and size of our device. \\

	The hardware research and development part of the project objective is covering a main need: production of an external device that enables communication between an Android system and a *shimmer through 802.15.4. Such a device should be a portable and low-powered device that can be plugged via the widely used USB On-The-Go (USB OTG) to a host Android system, acting the device as a slave.\\

	It has to be small sized because of the target application environment: a particular who requires constant, in-home, ambulatory monitorization. 
	%In that scenario devices that disturb regular working conditions are not valid at all;
	In that scenario unobtrusive operation is a main need, and usual life style activity modification is to be minimized. And it has to be low-powered, because were the power cost of application higher than that of the Bluetooth technology, a main adventage of 802.15.4 is lost.\\ 

	The ability to communicate through USB is required because, at the time, its is the most low battery consuming method to interact with Android powered platforms for any external device[quote here wlan and bt costs].\\

	And finally it should be able to act as the slave in the USB connection to avoid the need of an extra power source for the device that would increase the cost and size of the product.\\

	% OLD: In order to achieve this ambitious goal, we divide this develop in milestones that will help us to focus our works in more concrete tasks and correctly finish the project. \\

	In order to achieve such ambitious goals, and being aware of the substancial ammount of research involved in this part of the project, the decision was made to adopt a milestone driven development which simplified scheduling and helped focusing on specific tasks while maintaining a global view of the evolution and the objectives of the project.\\

	\section{Overview}
	% Before of introduce more infromation about our project we have a section of technologies that will be very usefull to understand all this chapter and that will be referenced many times in other sections

	Before diving any further into the development a section describing technologies involved in the research process is presented, as such information will be key to the understanding of the rest of the chapter and will be throughoutly referenced during the exposition.\\

	Then a description of the hardware research and development process is given, followed by detailed explanation of each projected milestone, including objectives pursued, lines of research developed, results of each one and conclusions obtained. Estimation based decision making being crucial for the correct outcome of the project, special care will be put to explain the motivations for each decision made. The chapter concludes with an exposition of the results of the research and subsequent development.

	\section{Researched Technologies}
	%mini introducción diciendo que para la correcta comprensión de está sección surge la necesidad de explicar en mayor o menor profundidad las siguientes tecnologías usadas en algún punto del desarollo del proyecto.

	% The hardware part of this project containts a lot of terms and technologies which is important to know to a correct understanding of the following section but because of it's size we can't explain it whitout a own section because it would become a very heavy doucment and probably lost the reader attencion and the section purpose.

	This part of the project involves a lot of terms and references a number of technologies and concepts which are important to be acquainted with in order to achieve a full understanding of the current chapter. These explanations won't be presented interlaced with the rest of the sections due to the unmanageable size they would acquire leading to a loss of focus which can only act against full comprehension of the exposed content.

		\subsection{Arduino}
		\label{ssec:Arduino}
		\subsection{MSP430}
		\subsection{Shimmer}
		%Posibilidad de tras la epxlicación inicial meter dos secciones más que expliquen las diferencias entre los dos chips y las dos placas usadas(hablarlo todos)
		\subsection{802.15.4}
		\label{ssec:802.15.4}
		\subsection{FreeRTOS}
		\label{ssec:FreeRTOS}
		%Pedir información a recas y referencias a recas
		\subsection{USB device \& USB host}

	\section{Description}

	%Esta parte es el cuerpo de la parte de investigación del proyecto, no se sabía si se podía, no se sabía cómo hacerlo, …

	% The hardware is the center section of the research in the whole project, not because there wasn't more research, but because nobody has researched this areas. At the begining we just know what we want to do but we have absolutely nor idea or clues about how we can do a very important number of our *milestones. In any cases we don't even know if our goals could be achieved, in particular a very important one, we need to connect a MSP430 to a Android where Android acts as host, and nobody achieve this before and therefore there are no information about that in forums or TI official support.\\

	The hardware related investigation is the main section of the research part of the project. Not that there wasn't any research involved in other areas, but some critical elements of this part had never been researched before. 
	At the beginning of the project specific objectives were established and main milestones elected, but absolutely no clue or direction for most of those milestones was available.
	Moreover, in some cases the feasibility of the proposed goals was unknown. Specifically the achievement of the very important objective of USB communication between an [TI's] MSP430 %(ponemos algo más de info o ya se sabe el modelo y todo?) 
	and an Android powered device assuming the latter the role of master and acting the former as a slave was something not done before and therefore no information was available  even in the Texas Instrument support site.\\

	%Plantea un reto porque toca todos los niveles, desde diseño de PCB a nivel componente hasta desarrollo a nivel de SO (kernel? <= investigar si kernel o SO)

	% The project suppose a chalenge because it involves every hardware level, form the lower levels as the PCB design of a device to higher levels as develop parts of a SO. *Aqui molaria poner algo más que dos tristes lineas. \\

	This whole development and research poses some quite interesting challenges as it involves working nearly at every abstraction layer present on device development, ranging from schematic capture and PCB design to operating system related development. The main issues to be resolved are:
	% La idea es refactorizar un poco lo que había en la scrap zone, introducir los puntos que debe resolver
	% el accesorio y después dar paso a los hitos, donde se relaciona cada uno con estos objetivos.
	\begin{itemize}
		\item \textbf{802.15.4 radio reception:}
			data packets are emitted from the monitoring Shimmer\texttrademark and are to be received and dealt
			by the accessory. In order to do so, FreeRTOS has to be equipped with a working implementation of
			the radio stack, which involves implementing part of ZigBee's MAC layer, described by the IEEE 802.15.4
			standard, as it is what the emitter nodes use. 
		\item \textbf{MSP430 USB handling:}
			\begin{comment}
			% Refactor and translate this
			The interaction between MSP430 and android was the most dangerous risk of this develop because there aren't information of any kind because it's not researched. USB is quite not as simple as everybody believes, there are many different protocols that works with USB, and each protocol can be implemented in very different ways, this implies a huge investigation process to find if any of them can be used by us. The final way to communicate both devices will be extendedly explained en section 3.4.2.\\
			\end{comment}	
		\item \textbf{MSP430-Android communication:}
			% It has never been done before (it is already said, but it is worth the insistence).
			% It is not obvious, it should not work out-of-the-box (although it did).
			% Maybe host vs device explanation?
	\end{itemize}
	
	\begin{comment}
	Extend this paragraph?\\
	
	Scrap zone.\\

	% Rafa: estos siguientes párrafos no los entiendo bien, son como un adelanto de las dificultades del desarrollo o...?
	% Quizas seria bueno introducir una pequeña explicación de qué vamos a contar, o asegurarnos de que queda muy claro para que la gente como yo no se líe
	% USB device vs host. 
	As we explain in the subsection 2.2.5 *Como se ponen enlaces?* the host rol is assumed by who manage the connection, and device rol by the one who just use this connection to send and recive data and recive energy, for us, this minds a simpler programming in our MSP430 device, which code is harder to develop than android code.\\

	%Bluetooth vs ZigBee(NO, 802.15.4). A lo mejor es suficiente con lo de la introducción(estudiar esa sección)
	We decided to use 802.15.4 instead of Bluetooth for many reasons, like lower consums or aviability to create networks to cover big surfaces. But the more important one is that *shimmer have a very small battery that, with bluetooth just lasts 5 or 6 hours, but with 802.15.4 it colud lasts more than a week. Talking about the delineator device that have to be carried by the patient, the difference between charge the device 3 or 4 times every day and charge it less than once every week is more than significant.\\
	\end{comment}

	% Con todo esto en mente y bla bla se plantean los siguientes hitos
	% Párrafo para introducir los hitos en el que no tengo ni idea que decir, viva!*	
	Over the following lines within the next section, the aforementioned challenges are detailed
	in the context of their own development stages. In addition, objectives and results of each one of
	these stages are also presented.
	
	\section{Milestones}	
	This section is presented in chronological order and with milestones view due to its research content, and also because of this was the planification that we follow, as we have no idea of what troubles can we found or how far we can ¿overtake? we have to plan the following milestones and its ¿contents?%desarrollos	

	%Meter una descripcion bastante mas detallada del porque de las plaificaciones y tal y tal

	%A ver, primero sabiamos que queriamos conectar algo por USB que recibiera por 802.15.4(esto hacia ver 2 grandes hitos, conseguir comunicación radio y conseguir comunicación USB)
	We have a serie of tentative milestones pretty clear since the start of the project for this reseach part, like connect the device with android via USB or be able to communicate trought 802.15.4 with a shimmer.\\

	%Dado que un profesor de la facultad y director de nuestro proyecto había portado una capa MAC para un sistema operativo para MSP430F5438A decidimos que o ese o alguno de su familia sería nuestro microchip destino, para ahorrar ese trabajo
	There are a project making a port of the necessary part of MAC layer of 802.15.4 developed over FreeRTOS by one UCM informatics faculty teacher, Joaquin Recas\begin{todo}mencionamos profesores o no?En caso de que si, referencia al paper\end{todo}, this port work in shimmer, our target delineatior device, and MSP430F5438A, the easier develop of the 802.15.4 in this kind of devices make that the MSP430 becomes the choosen develop platform.\\

	\begin{todo}preguntar a recas que ha hecho exactamente el del FreeRTOS que usamos, y preguntar si podemos mentarle\end{todo}

	%El micro concreto para el que estaba hecho el port no proveía USB por lo que el microchip destino fue el MSP4306638, que era el más potente de la familia MSP430F66xx, que soporta USB y por tanto nos interesaba(esto cambia conseguir USB por conseguir USB en MSP430F6638(\autoref{MSP430 for Android USB Host Comunication}) y concreta el conseguir comunicación por radio a portar la radio del MSP430F5438A al MSP430F6638(\autoref{802.15.4 in FreeRTOS}).
	Unfortunately this concrete device, the MSP430F5438A, since now the old MSP430, have not support to USB communication, and there are no way to adapt it. Then after seek in TI, the MSP430 manufacturers, the final prptotyping platform was the MSP430F6638, the highest performance device of MSP430F66xx family wich ones provides USB suport, this device do not support the radio module, but is possible to adapt it. This decision reduces the radio work to port the 802.15.4 to a similar microchip and concreete the first tentative milestones into definitives \autoref{MSP430 for Android USB Host Comunication} and \autoref{802.15.4 in FreeRTOS}. \\

	%Dado que la capa MAC del 802.15.4 está desarrollada sobre el FreeRTOS(\autoref:{FreeRTOS}) hace falta un hito para portar la comunicación USB al sistema operativo\autoref{USB in FreeRTOS}
	This las decision trigger the need to planify a new milestone to port the USB communication, that was stand alone, into a task-based SO as FreeRTOS \autoref{USB in FreeRTOS}. Probably this milestone have not so much load as others and could be joined with the another USB milestone, but simplify as much as possible the \autoref{MSP430 for Android USB Host Comunication} was esential because USB connection with android was a pretty defficult scenario and is necessary keep it isolated.\\

	%La más que imporante complicacion de estas dos comunicaciones nos hace pensar que es preferible conseguirlas por separado y luego juntarlas en otro hito( \autoref{ssec:802.15.4 \& USB coexistence under FreeRTOS}
	This two conceptual milestones, USB and 802.15.4 communication, was decided to be develop separately instead of cumulatively to ensure that the work in one is not affected at all by the other one. In this scenario a milestone dedicated to put it together under the FreeRTOS is posed, \autoref{ssec:802.15.4 \& USB coexistence under FreeRTOS}.\\
	%La comunicación por USB del android con el MSP430 no existe, no se había conseguido y encima la disposición de android como USB host es una caracteristica muy nueva de android. Pensamos que es necesario un hito anterior para acostumbrarnos a la comunicación con android por USB como device, para facilitar la aclimatación y no meternos al principio con un tema tan complicado, este hito consistiría en conectar un dispositivo de tipo arduino(primeramente pensamos googleADK) para los cuales la comuicacion USB con android como device está probada.(surge el hito 4 \autoref{ssec:Arduino for Android USB Device Comunication})
	At this point is noticed that the first USB contact with android was directly try to connect an android device with the MSP430 using the android device as host. The MSP430 USB communication with Android was not already developed by nobody else and the Android USB host communication have no more that a couple of months released. A easier initial milestone, \autoref{ssec:Arduino for Android USB Device Comunication}, to familiarize the team with the USB seems very usefull at this point. Is decided to use an \autoref{Arduino}, because Arduino have been connected with android many times and was able to act as host in the connection, to make a first and not too lasting aproach to USB communication.

	%Se plantea una potencial iteración posterior por si el proyecto fuera bien y diese tiempo consitente en crear el dispositivo final capturando el esquematico y diseñando el PCB para producirlo.Se presenta inicialmente como un hito tentativo dado que el tiempo que se puede tardar en realizar las anteriores hiteraciones es bastante incierto pero se prefiere tener el horizonte lo más lejos posible
	Just because this is a mainly research section this milestones can't have a realistic estimate time, and because of that we are not able to know when this milestones can be finished, nor even if all could be finally achieved. Just in case we finish this milestones enought soon, and in order to have an horizon as far as possible, id decided to put another milestone that could make our system and project more complet, \autoref{MSP430 based device design}, where will be developed the final device capruting the schematic and designing the PCB for a finished hardware device.\\
	
	%Para evitar sopresas de última hora o olvidar dejar tiempo para las pruebas finales de aplicación y corrección de ultimos bugs se crea un hito final.\autoref{Final Validation and Release Candidate Version Development}
	A last milestone was planned to do not make the mistake to develop until the last day and close the project with a product not estable enought, \autoref{Final Validation and Release Candidate Version Development}.

	%Ahora que todas han sido presentadas explicar el orden de las mismas(porque USB antes que radio)(criticidad)
	The USB related milestones was planified before the radio ones because the criticality of them. The chances of do not achieve the milestone of communicate the MSP430 via USB with android are pretty high and if this happends, is important to discover it as soon as possible in order to overhaul the project scope and replanificate the hole work.\\

	%Meto una tabla con las fechas en que conseguimos cada logro y empezamos su investigación?
	The inicial plannification is as this table shows:\\



	TABLE HERE\\




	%Y con todos ustedeeees las milestoooooooones
	A detailed description of each milestone is presented next: 

		\subsection{Arduino for Android USB Device Comunication}
		\label{Arduino for Android USB Device Comunication}
		This first milestone's objectives are:
		\begin{itemize}
		% \item Acquire a Google Android Development Kit,
		\item Acquire a suitable Android device prototyping environment, 
		\item manage correct communication between Android and a prototype device, and
		\item develop an application emulating desired behaviour.
		\end{itemize}
		%Prototipo sencillo que sirvió para familiarizarnos con la programación de USB en android, rápido porque la parte del arduino estaba hecha, y programar USB device en Android(referencia a algúna parte del software donde se cuente como de facil se implementa eso) no supone demasiada complicación

		The process involved in the procurement of each objective is exposed next.

		\begin{enumerate}

		\item Acquire a suitable Android device prototyping environment
		Initial research on the subject of Android device prototyping 


		When we decide to develop a usb device the first step is look for a device tha provide the USB host libraries to connect to android, because the USB host device is which implements most of comunication, thanks to this we can focus our efforts in just try a comunication with android with not so much worries, the device selected to this end was the goole ADK, that is based on arduino(link).ADK is a device developed by google to help android developers to make his first prototypes of USB connected devices. The google ADK is an Arduino with all the facilities that a developer can expect such as libraries, some shields, examples and a good documentation, in our case we are specialy interested in the USB host comunication libraries.\\

		\item Manage correct communication between Android and a prototype device

		%Tuvimos el arduino 16 de Noviembre pero no empezamos a trabajar con el el día que nos llegó(de hecho pasó lo menos una semana o 2) asi que o mencionamos eso o ponemos que nos llegó mas tarde de lo que nos llegó de verdad
		
		 When we reciebe our google ADK(link to an image?) we investigate documentacion and we start to develop a small arduino aplication based on the expamples, paraelly we develop the android USB device part(link) that we be needed to test this part of  communication. The initial develop, just to make the first test was a little long, because even been the main parts of the implementation os USB comunication made we need to learn how to use it. Our first attempts was no very productives because arduino was a new develop platform but especially because this was our first try with android USB comunication. \\

		\item Develop an application emulating desired behaviour

		Several days later we achieve to Andorid and ADK view each other, but in our definitive test we discover that the communication was not correct because what anyones send was not recibed equally by the other one. But finally we discover what was going wrong and fix it to view how our first milestone has been ahieved.\\

		\end{enumerate}

		%Conclusion
		Once finished we discover the huge importance of plan this first milestone, that will not be used in then final device, but it was very usefull to train the team about USB comunication in android. Conidering than this milestone was not as easy as we expect, if we had start the research in the second milestone which investigation is actualy used in the device, we probably found a lot of troubles that wasn't trully related with the investigation and it would be higly sealed.\\

		%Fue finalizado el 19 diciembre

		\subsection{MSP430 for Android USB Host Comunication}
		\label{MSP430 for Android USB Host Comunication}
		%Se comenzó tras las vacaciones de invierno, a finales de enero
		This milestone's objectives are:
		\begin{itemize}
		\item Supply MSP430 with USB protocol application functionality,
		\item research Android USB protocol related functionality,
		\item get Android system to recognize MSP430 as a plugged device, and
		\item manage communication between Android and MSP430 via USB.
		\end{itemize}


		%Plantear de manera lo más cronológica posible remarcando que aui estabamos totalmente a ciegas, no sabíamos como ibamos a alcanzar nuestro objetivo, solo teníamos una API USB proporcionada por TI para comunicación USB con windows: 
		Unlike the arduino's part where we know what we have to use and how we wil use it, now we found that we just have an Texas Instruments(TI) API to comunicate the MSP430 with windows and our goal. Both MSP430 microcontroller and MSP430 board was new devices because all the existing ones have no USB port, the microcontroller is a MSP430 6638 and the board is a TS430PZ100USB(link to the MSP430 section).\\

		This API contains any simple aplications for windows, to comunicate by certain protocols with external devices or enumeration tools; an extense documentation about the API and about the USB characteristics of its devices; and a huge suite of examples that implements a lot of USB protocols to comunicate the MSP430 whith windows such as Communications Device Class (CDC), Personal Healthcare Device Class (PHDC), Human Interface Device (HID) in traditional and datatype implementations, Mass Storage Class (MSC) and combinations of any of them. At this point we have an inmense amount of information and we don't really know what can be usefull for us.\\
		
		%Introduccion y no va
		Initialy in order to test the TI API we check some of the multiple examples, in our case was the CDC examples that be usefull to learn about basic concepts of what we try to do. Also we try to read part of the generic(not dependant of the MSP430 device nor USB protocol)documentation that TI provides. And it didn't start too good, the first test with a example provide in the API didn't work in windows, its target SO.

		%LE FALTABA UN PUTO RELOJ DE 4MHZ
		After a good time of investigation we found that it can't initialize a certain clock, this clock don't seems to be in the board and we there are not much references about it. Finally we found a little paragraph in one API document that metion the chance of a USB needed clock was not included in any kind of boards and a recomendation of how should be this clock, when we buy a clock of this features we can check that this was the problems, the TI example finally works.

		%En ubuntu no va, mal rollito
		All this tetst was carried out in a virtual machine with windows usually running over other windows, but in a casual situation when this virtual machine was running over ubuntu we discover that this examples not only don't work in ubuntu, somthing that we assume, but in addition ubuntu can't even detect our MSP430, this fact worry us because android is an UNIX based SO just like ubuntu. \\

		%Líneas de investigación
		When we try to connect our MSP430 running one of this examples mentioned before we obvserve that, as we expect, android also can't detect it. Initialy we think our only posible solution to this important trouble was make or found a unix driver, then we investigate that way. \\

		%Driver propio para linux
		%Driver propio para android (ambos sobre driver TI MSP430 para MAC)
		%[Mencionar Riesgos asumidos al abandonar línea driver propio y seguir investigando]
		After much searching we see that there are no drivers for unix made by anyone, the closest driver we find was a MAC driver(that we are not sure that it going to work) and assuming that we will need to do a driver based on it, we consult some cualified personal in this area that said us to forget the idea of a generic UNIX driver and focus in an android driver, but also recommend that keep researching other ways to communicate android and MSP in order to avoid the develop a driver for MSP430 wich can be a very difficult work. This advice and the fact that there are no warraties of the develop of a driver was succesfull, we decide to leave the driver idea and follow investigating. That was a very risky decision because we have spended a lot of time in this way and we don't know if we will find other idea to ahieve this hard milestone.\\

		%Encontramos mención a driver genérico HID en android + TI’s HID api for MSP430s
		After a few days of unsuccesfull days of investigation, we find in a forum a small mention in a comment about android actually implements HID protocol. This protocol was also suported by the MSP430 API, and although the information was found in a not very condiable place, we find it enought to put the full team to work in this, ones made the android USB host(link) and others find a HID aplication into the API to load into the MSP430. The second objetive was attenpted first, with this we can check that our android device finally detect our MSP430. \\

		%Probamos y funcionó (más trabajo software, enlazar a capítulo) , comentar la importancia del hardware en esta parte de la programación android debido a que ese código es muy dependiente de como implemente el protocolo HID(que proporciona mucha libertad)el MSP lo que supuso mucha investigación y continuo acceso a manuales tanto de la API como del propio MSP(ese comentario iria aqui o en la parte de software?Hablarlo todos)
		That great news helps the android development team, than in this moment becomes the full team, to succesfully imlements the android USB host communication in our aplication in just a weekend. Android USB host comunication was higly dependant of what device was in the other side of the communication, thus everybody was needed in this hard and delicated part of the develop to investigate the high cuantity of manuals contained in the API in orther to find and implement all this particularities. Finally we luckily discover that now, our android and MSP430 can also comunicate each other trought our aplication. \\

		%Conclusion
		That was wtih no doubts the harder and more dangerous part of the research, there was a lot of chances to do not achieve our goal and the hard work of all the team was essential. This milestone suppose a very important fact not only in hardware part but in all the project because now, we can more accurately schedule all of the project. \\


		\subsection{USB in FreeRTOS}
		\label{USB in FreeRTOS}	
		This milestone's objectives are:
		\begin{itemize}
		\item Validate the use of FreeRTOS in the new tarject MSP430
		\item Validate USB API utilization viability in conjunction with FreeRTOS in MSP430,
		\item correctly integrate USB API into FreeRTOS, and
		\item manage USB data sending in FreeRTOS.
		% REALIZACION: port testing application to FreeRTOS task system.
		\end{itemize}
		%Antes de cambios o mierdas, miniintroduccion del freeRTOS y referencía a su capitulo?(jrecas)

		%Pequeños cambios en FreeRTOS para soportar la nueva plataforma 6638
		Before to start the real objetive of this milestone we need to adapt the FreeRTOS main functionalities to the new MSP430, that been a new device was not actualy supported by. This mind the creation of a good number of new clases, most of them was excatly equal to their homonimes for the MSP430 5438A but other needs some little modifications.\\

		%Adaptación de la API para hacerla funcionar en un SO basado en tareas como es el FreeRTOS
		%Importantes riesgos de conflictos a nivel de compartición de recursos hardware, que con cuidado(más con suerte que con cuidado) pudieron ser esquivados.
		The next need in the milestone was port as soon as posible the TI USB API to a task-based SO like FreeRTOS whithout taking too much care about its correction. The introduction into the FreeRTOS was prety problematic because the size of just the the API was near to the size of the FreeRTOS. Plus, there are a very important risk, USB uses a important number of resources as pines or clock that can be also used by the FreeRTOS to another task, specially risky was the clock because both need a clock, but the selected board have 2 clock spots, and taking care in the port all this themes could resolved and everything works fine.\\

		%Estaba hecho pero mal, había inclusiones puestas donde no se debía y ya no se podía ejecutar ese mismo código en el shimmer o el antiguo MSP430.
		Once it's done our preocupation was how to order all this files in a correct way, because our free RTOS was a multiplatform SO that must work in MSP430 5438A, Shimmer, and now, the new MSP430 6638 where take place this develope. In the first port where the multiplatform ability of FreeRTOS was not a problem we lost this funcionality. This separation of tasks help pretty much in focus the first steps in this milestone. This new functionality have to be included just in the supported platform, the MSP430 6638, without affect the other ones as before. Using the preciding generalization needed to cohexists Shimmer and MSP430 5438A as a guide this port was not too traumatic.

		\subsection{802.15.4 in FreeRTOS}
		\label{802.15.4 in FreeRTOS}	
		This milestone's objectives are:
		\begin{itemize}
		\item Validate current implementation of 802.15.4 in FreeRTOS in testing MSP430,
		\item manage connection to the CC2420 radio module to target MSP430 device,
		\item port implementation of 802.15.4 to target MSP430 device, and
		\item prepare such implementation for actual usage.
		\end{itemize}
		%Estado de la capa MAC
		At the beginining of this milestone there are a port of the needed part of the MAC layer of the 802.15.4, that have been tested in just certain conditions, like send of medium lenght packets.\\

		%Radio probada en una placa que no proveía USB pero sí salida por puerto serie para simplificar trabajo y facilitar la depuración,		
		As we are not sure of the right working of MAC layer in our system we decide to test it with the old board and microchip that provides serial port output that is extreamly usefull in the debug of a real-time system like this. This result to not works for a certain problems as although it's able to recibe 802.15.4 packets it's not programmed to it, and the max size packets wasn't recived correctly.\\

		%se llevó luego a otra con USB pero sin soporte ni software ni hardware para la radio, obligando a mapeo manual de pines,
		Once the right working of the MAC layer is tested, it's time to port it to the new board and microchip, that implies a lot of troubles because the TS430PZ100USB have no conection to a CC2420 radio module. This mean that a full study of the 100 aviable pins to discover which ones are actually unused by both the SO and USB comunication. The radio modlule alse need a particular kind of pins in some cases that there are no very abundant. With this study and the mapping of pins made(mencionamos a carlos?) board and radio module is sent to be weld.\\

		%que ahora si con más mañana que suerte se hizo bien y no dio conflicto como veremos ahora aunque si hubo que modificar algo más de código dado que la nueva placa necesitaba iniciar los pines de la radio de otra forma.
		While the board is available, we addressed the programming the pin mapping for de MSP430F6638 into it's class in the FreeRTOS using as base the MSP430F5438A pin mapping class. This is a particulary delicated code and was carefully developed, because if just one thing is not perfect the radio simply didn't work at all and the potencial error will be hard to discover. \\

		% No va, había que cambiar un par de cosas en la inicialización, lo descubrimos en un ejemplo de TI
		With both, board and codding finished the radio was tested and it didn't even trun on. The answer to this trouble was found in a code examples provided by TI for the MSP430F6638, specifically in the \textit{Universal Asyncronous Reciver/Transmiter(USART) initialization code} that reslut to differ slightly of the old MSP430 USART initialization.\\

		%Pequeños cambios para adaptarse a nuestras actuales necesidades y conclusión
		Finally some small changes was done in order to adapt it to our project needs. With this a fully funcitonal MAC layer working on the MSP430F6638 was achived and just the potential coexistence with the USB was on the air.\\

		%Comentar que este trabajo se hizo en colaboración con joaquin (jrecas)?

		\subsection{802.15.4 \& USB coexistence under FreeRTOS}
		\label{802.15.4 \& USB coexistence under FreeRTOS}	
		This milestone's objectives are:
		\begin{itemize}
		\item Assess conflict-free coexistence of current implementation of both USB and 802.15.4 modules in MSP430, and
		\item manage sending data received from 802.15.4 via USB.
		\end{itemize}
		%Intro
		With both USB and 802.15.4 communication working separately we need to test that they can work together. There are 2 main risks; hardware, because any pines used in 802.15.4 can be used also in USB and software, because the time between a radio interruption and the next radio interruption could be too short to send the data trought USB.\\

		%Riesgos de conflicto hardware entre Radio y USB
		The hardware risk was adviced much before the begining of this milestone, and when we made de pin mapping we keep in mind this risk, thanks that, this risk was avoided.\\

		%Riesgos de conflicto software entre Radio y USB sobre FreeRTOs
			%(Falta de tiempo para enviar y recibir)
		%Darle mucho peso a los riesgos y ver como tratar el tema de que no hubo prácticamente ningún problema con ellos(solo al de tiempo para enviar y recibir) sin que se note que este punto no tuvo mucho peso
		However the software risk was initialy not avoided because the Shimmer send data paquets too fast and MSP430 can't manage this amount of information to send it trought USB and some packets was lost. A little adjusts was necesary, the packets sent was concentred in the start of the available time slots then, we spaced it, sending the same number of packets but with the same time between packet and packet, filling the whole aviable time slots. \\

		%Este hito hacia falta aunque fuese breve para tener el sistema lo más estable posible antes de lanzarnos a probar la aplicación final
		Now, our system was finally able to send trought USB the packets recived in radio with no losses. This achievment was very important before develop and test the final aplication with several real-time restrictions.\\

		\begin{comment}
		\subsection{Final aplication develop}
		\begin{itemize}
		\item Obtention of a shimmer final aplication,
		\item Obtention of a Android aplication, and
		\item Test the whole system in its real use.
		\end{itemize}
		
		%Le pedimos a fran(mencionamos a fran?) que nos pasara una aplicación que enviara todo lo que era capaz de enviar el shimmer por radio, no la tenía y la tuvo que hacer, acabamos la parte sofware para parsear los datos llegados por USB y a probar.
	
		%Sabiamos que funcionaba con nuestros ejemplos pero faltaba comprobar si funcionaría con la aplicación objetivo del shimmer que tenía unas restricciones de envío más altas y como no podía ser de otra forma no funcionó. Nos agobiamos, rafa se temió lo peor, el shimmer enviaba mal, el tablet parseaba mal, pero nada de esto resolvía los problemas y al final tuvimos suerte y se arregló.
		\end{comment}
		\subsection{MSP430 based device design}
		\label{MSP430 based device design}	
		\begin{itemize}
		\item Board exhaustive analysis,
		\item Capture of the schematic, and
		\item PCB design and route.
		\end{itemize}
		%Algo en plan, finalizada la investigación y gracias a que pusimos mucho empeño en acabar con tiempo suficiente fuimos capaces(como de tener la capacidad, no de conseguir(be able to)) de diseñar un dispositivo a partir de los componentes presentes en la placa de prototipado.
		%Identificación de componentes de placa 
			%(pines de expansión)
			%(cambio de componentes por otros)
			%(eliminacion JTAG y reutilizacion Radio)
		%Captura de esquemático
		%Diseño PCB
		%Rutado PCB

		\subsection{Final Validation and Release Candidate Version Development}
		\label{Final Validation and Release Candidate Version Development}	
		\begin {itemize}
		\item Final validation of final aplications with prototyping hardware
		\item Final validation of final aplications with final hardware
		
		
		%Esteeee si, mencinamos que esta milestone existía porque había que hacer las pruebas pertinentes ahora que todo estaba completo y comentamos lo que sea que vaya a pasar cuando esté todo.

		\section{Final Product}
		%Descripción de que es lo que hemos conseguido(es posible que con la evolución alguien que se lea las iteraciones no consiga una clara visión de cual es el estado final del dispositivo, por lo que esta parte me parece muy importante)
		%Tener cuidado de que no haya algo muy parecido en la parte de la introducción, aunque si debiera un miniresumen del producto, lo que de la conclusión debería incluir tambien posibles usos no contemplados de lo que hemos conseguido.
