\chapter{Hardware and communications}
\label{ch:hardware}
	\section{Overview}	
	%que necesidad cubre la parte hardware del proyecto

	% OLD: The hardware in our project cover a main need, an external device to be able to communicate our android device with a *shimmer through 802.15.4. Than device have to be a little and low powered device that can be conected as device through USB in an android device. Little, because a device that disturb a regular work is not valid at all. Low powered, because if the cost of power the divece is higher than use the stack bluetooth we lose an important adventage of use 802.15.4. Able to be coneced throught USB in our android device because this is the only way to interact with android for a external device. And finally able to be connected as device to elimminate the needed of an extra batery that would have incresed the cost and size of our device. \\

	The hardware research and development part of the project objective is covering a main need: production of an external device that enables communication between an Android system and a *shimmer through 802.15.4. Such a device should be a portable and low-powered device that can be plugged via the widely used USB On-The-Go (USB OTG) to a host Android system, acting the device as a slave. It has to be small sized because in the target application environment (Medical environs, link to somewhere?) devices that disturb regular working conditions are not valid at all; and low-powered, because were the power cost of application higher than that of the Bluetooth technology, a main adventage of 802.15.4 is lost. The ability to communicate through USB is required because, at the time, its is the most low battery consuming method to interact with Android powered platforms for any external device[quote here wlan and bt costs]. And finally it should be able to act as the slave in the USB connection to avoid the need of an extra power source for the device that would increase the cost and size of the product.\\

	% OLD: In order to achieve this ambitious goal, we divide this develop in milestones that will help us to focus our works in more concrete tasks and correctly finish the project. \\

	In order to achieve such ambitious goals, and being aware of the sustancial ammount of research involved in this part of the project, the decision was made to adopt a milestone driven development which simplified scheduling and helped focusing on specific tasks while maintaining a global view of the evolution and the objectives of the project.\\

	% Before of introduce more infromation about our project we have a section of technologies that will be very usefull to understand all this chapter and that will be referenced many times in other sections

	Before diving any further into the development a section describing technologies involved in the research process is presented, as such information will be key to the understanding of the rest of the chapter and will be throughoutly referenced during the exposition.

	\section{Researched Tecnologies}
	%mini introducción diciendo que para la correcta comprensión de está sección surge la necesidad de explicar en mayor o menor profundidad las siguientes tecnologías usadas en algún punto del desarollo del proyecto.

	% The hardware part of this project containts a lot of terms and technologies which is important to know to a correct understanding of the following section but because of it's size we can't explain it whitout a own section because it would become a very heavy doucment and probably lost the reader attencion and the section purpose.

	This part of the project involves a lot of terms and references a number of technologies and concepts which are important to be acquainted with in order to achieve a full understanding of the current chapter. These explanations won't be presented interlaced with the rest of the sections due to the unmanageable size they would acquire leading to a loss of focus which can only act against full comprehension of the exposed content.

		\subsection{Arduino}
		\subsection{MSP430}
		%Posibilidad de tras la epxlicación inicial meter dos secciones más que expliquen las diferencias entre los dos chips y las dos placas usadas(hablarlo todos)
		\subsection{802.15.4}
		\subsection{FreeRTOS}
		%Pedir información a recas y referencias a recas
		\subsection{USB device \& USB host}

	\section{Description}

	%Esta parte es el cuerpo de la parte de investigación del proyecto, no se sabía si se podía, no se sabía cómo hacerlo, …

	% The hardware is the center section of the research in the whole project, not because there wasn't more research, but because nobody has researched this areas. At the begining we just know what we want to do but we have absolutely nor idea or clues about how we can do a very important number of our *milestones. In any cases we don't even know if our goals could be achieved, in particular a very important one, we need to connect a MSP430 to a Android where Android acts as host, and nobody achieve this before and therefore there are no information about that in forums or TI official support.\\

	The hardware related investigation is the main section of the research part of the project. Not that there wasn't any research involved in other areas, but some critical elements of this part had never been researched before. 
	At the beginning of the project specific objectives were established and main milestones elected, but absolutely no clue or direction for most of those milestones was available.
	Moreover, in some cases the feasibility of the proposed goals was unknown. Specifically the achievement of the very important objective of USB communication between an [TI's] MSP430 %(ponemos algo más de info o ya se sabe el modelo y todo?) 
	and an Android powered device assuming the latter the role of master and acting the former as a slave was something not done before and therefore no information was available  even in the Texas Instrument support site.\\

	%Plantea un reto porque toca todos los niveles, desde diseño de PCB a nivel componente hasta desarrollo a nivel de SO (kernel? <= investigar si kernel o SO)

	% The project suppose a chalenge because it involves every hardware level, form the lower levels as the PCB design of a device to higher levels as develop parts of a SO. *Aqui molaria poner algo más que dos tristes lineas. \\

	This whole development and research poses quite an interesting challenge as it involves working nearly at every abstraction layer present on device development, ranging from schematic capture and PCB design to operating system related development.
	Extend this paragraph?\\
	
	Scrap zone.\\

	% USB device vs host. 
	As we explain in the subsection 3.2.5 *Como se ponen enlaces?* the host rol is assumed by who manage the connection, and device rol by the one who just use this connection to send and recive data and recive energy, for us, this minds a simpler programming in our MSP430 device, which code is harder to develop than android code.\\

	%MSP430 interacción con android
	The interaction between MSP430 and android was the most dangerous risk of this develop because there aren't information of any kind because it's not researched. USB is quite not as simple as everybody believes, there are many different protocols that works with USB, and each protocol can be implemented in very different ways, this implies a huge investigation process to find if any of them can be used by us. The final way to communicate both devices will be extendedly explained en section 3.4.2.\\

	%Bluetooth vs ZigBee(NO, 802.15.4). A lo mejor es suficiente con lo de la introducción(estudiar esa sección)
	We decided to use 802.15.4 instead of Bluetooth for many reasons, like lower consums or aviability to create networks to cover big surfaces. But the more important one is that *shimmer have a very small battery that, with bluetooth just lasts 5 or 6 hours, but with 802.15.4 it colud lasts more than a week. Talking about the delineator device that have to be carried by the patient, the difference between charge the device 3 or 4 times every day and charge it less than once every week is more than significant.\\

	%Con todo esto en mente y bla bla se plantean los siguientes hitos
	*Parrafo para introducir los hitos en el que no tengo ni idea que decir, viva!*	
	
	\section{Milestones}	
	This section is presented in chronological order and with milestones view due to its research content, and also because of this was the planification that we follow, as we have no idea of what troubles can we found or how far we can ¿overtake? we have to plan the following milestones and its ¿contents?%desarrollos	

		%Meto una tabla con las fechas en que conseguimos cada logro y empezamos su investigación?

		%Meter una descripcion bastante mas detallada del porque de las plaificaciones y tal y tal

		\subsection{Arduino for Android USB Device Comunication}
		This first milestone's objectives are:
		\begin{itemize}
		% \item Acquire a Google Android Development Kit,
		\item Acquire a suitable Android device prototyping environment, 
		\item manage correct communication between Android and a prototype device, and
		\item develop a application emulating desired behaviour.
		\end{itemize}
		%Prototipo sencillo que sirvió para familiarizarnos con la programación de USB en android, rápido porque la parte del arduino estaba hecha, y programar USB device en Android(referencia a algúna parte del software donde se cuente como de facil se implementa eso) no supone demasiada complicación	
		When we decide to develop a usb device the first step is look for a device tha provide the USB host libraries to connect to android, because the USB host device is which implements most of comunication, thanks to this we can focus our efforts in just try a comunication with android with not so much worries, the device selected to this end was the goole ADK, that is based on arduino(link).ADK is a device developed by google to help android developers to make his first prototypes of USB connected devices. The google ADK is an Arduino with all the facilities that a developer can expect such as libraries, some shields, examples and a good documentation, in our case we are specialy interested in the USB host comunication libraries.\\

		%Tuvimos el arduino 16 de Noviembre pero no empezamos a trabajar con el el día que nos llegó(de hecho pasó lo menos una semana o 2) asi que o mencionamos eso o ponemos que nos llegó mas tarde de lo que nos llegó de verdad
		
		 When we reciebe our google ADK(link to an image?) we investigate documentacion and we start to develop a small arduino aplication based on the expamples, paraelly we develop the android USB device part(link) that we be needed to test this part of  communication. The initial develop, just to make the first test was a little long, because even been the main parts of the implementation os USB comunication made we need to learn how to use it. Our first attempts was no very productives because arduino was a new develop platform but especially because this was our first try with android USB comunication. \\

		Several days later we achieve to Andorid and ADK view each other, but in our definitive test we discover that the communication was not correct because what anyones send was not recibed equally by the other one. But finally we discover what was going wrong and fix it to view how our first milestone has been ahieved.\\

		Once finished we discover the huge importance of plan this first milestone, that will not be used in then final device, but it was very usefull to train the team about USB comunication in android. Conidering than this milestone was not as easy as we expect, if we had start the research in the second milestone which investigation is actualy used in the device, we probably found a lot of troubles that wasn't trully related with the investigation and it would be higly sealed.\\

		%Fue finalizado el 19 diciembre

		\subsection{MSP430 for Android USB Host Comunication}

		%Se comenzó tras las vacaciones de invierno, a finales de enero
		This milestone's objectives are:
		\begin{itemize}
		\item Supply MSP430 with USB protocol application functionality,
		\item research Android USB protocol related functionality,
		\item get Android system to recognize MSP430 as a plugged device, and
		\item manage communication between Android and MSP430 via USB.
		\end{itemize}


		%Plantear de manera lo más cronológica posible remarcando que aui estabamos totalmente a ciegas, no sabíamos como ibamos a alcanzar nuestro objetivo, solo teníamos una API USB proporcionada por TI para comunicación USB con windows: 
		Unlike the arduino's part where we know what we have to use and how we wil use it, now we found that we just have an Texas Instruments(TI) API to comunicate the MSP430 with windows and our goal. Both MSP430 microcontroller and MSP430 board was new devices because all the existing ones have no USB port, the microcontroller is a MSP430 6638 and the board is a TS430PZ100USB(link to the MSP430 section).\\

		This API contains any simple aplications for windows, to comunicate by certain protocols with external devices or enumeration tools; an extense documentation about the API and about the USB characteristics of its devices; and a huge suite of examples that implements a lot of USB protocols to comunicate the MSP430 whith windows such as Communications Device Class (CDC), Personal Healthcare Device Class (PHDC), Human Interface Device (HID) in traditional and datatype implementations, Mass Storage Class (MSC) and combinations of any of them. At this point we have an inmense amount of information and we don't really know what can be usefull for us.\\
		
		%Introduccion y no va
		Initialy in order to test the TI API we check some of the multiple examples, in our case was the CDC examples that be usefull to learn about basic concepts of what we try to do. Also we try to read part of the generic(not dependant of the MSP430 device nor USB protocol)documentation that TI provides. And it didn't start too good, the first test with a example provide in the API didn't work in windows, its target SO.

		%LE FALTABA UN PUTO RELOJ DE 4MHZ
		After a good time of investigation we found that it can't initialize a certain clock, this clock don't seems to be in the board and we there are not much references about it. Finally we found a little paragraph in one API document that metion the chance of a USB needed clock was not included in any kind of boards and a recomendation of how should be this clock, when we buy a clock of this features we can check that this was the problems, the TI example finally works.

		%En ubuntu no va, mal rollito
		All this tetst was carried out in a virtual machine with windows usually running over other windows, but in a casual situation when this virtual machine was running over ubuntu we discover that this examples not only don't work in ubuntu, somthing that we assume, but in addition ubuntu can't even detect our MSP430, this fact worry us because android is an UNIX based SO just like ubuntu. \\

		%Líneas de investigación
		When we try to connect our MSP430 running one of this examples mentioned before we obvserve that, as we expect, android also can't detect it. Initialy we think our only posible solution to this important trouble was make or found a unix driver, then we investigate that way. \\

		%Driver propio para linux
		%Driver propio para android (ambos sobre driver TI MSP430 para MAC)
		%[Mencionar Riesgos asumidos al abandonar línea driver propio y seguir investigando]
		After much searching we see that there are no drivers for unix made by anyone, the closest driver we find was a MAC driver(that we are not sure that it going to work) and assuming that we will need to do a driver based on it, we consult some cualified personal in this area that said us to forget the idea of a generic UNIX driver and focus in an android driver, but also recommend that keep researching other ways to communicate android and MSP in order to avoid the develop a driver for MSP430 wich can be a very difficult work. This advice and the fact that there are no warraties of the develop of a driver was succesfull, we decide to leave the driver idea and follow investigating. That was a very risky decision because we have spended a lot of time in this way and we don't know if we will find other idea to ahieve this hard milestone.\\

		%Encontramos mención a driver genérico HID en android + TI’s HID api for MSP430s
		After a few days of unsuccesfull days of investigation, we find in a forum a small mention in a comment about android actually implements HID protocol. This protocol was also suported by the MSP430 API, and although the information was found in a not very condiable place, we find it enought to put the full team to work in this, ones made the android USB host(link) and others find a HID aplication into the API to load into the MSP430. The second objetive was attenpted first, with this we can check that our android device finally detect our MSP430. \\

		%Probamos y funcionó (más trabajo software, enlazar a capítulo) , comentar la importancia del hardware en esta parte de la programación android debido a que ese código es muy dependiente de como implemente el protocolo HID(que proporciona mucha libertad)el MSP lo que supuso mucha investigación y continuo acceso a manuales tanto de la API como del propio MSP(ese comentario iria aqui o en la parte de software?Hablarlo todos)
		That great news helps the android development team, than in this moment becomes the full team, to succesfully imlements the android USB host communication in our aplication in just a weekend. Android USB host comunication was higly dependant of what device was in the other side of the communication, thus everybody was needed in this hard and delicated part of the develop to investigate the high cuantity of manuals contained in the API in orther to find and implement all this particularities. Finally we luckily discover that now, our android and MSP430 can also comunicate each other trought our aplication. \\

		That was wtih no doubts the harder and more dangerous part of the research, there was a lot of chances to do not achieve our goal and the hard work of all the team was essential. This milestone suppose a very important fact not only in hardware part but in all the project because now, we can more accurately schedule all of the project. \\


		\subsection{USB in FreeRTOS}	
		This milestone's objectives are:
		\begin{itemize}
		\item Validate the use of FreeRTOS in the new tarject MSP430
		\item Validate USB API utilization viability in conjunction with FreeRTOS in MSP430,
		\item correctly integrate USB API into FreeRTOS, and
		\item manage USB data sending in FreeRTOS.
		% REALIZACION: port testing application to FreeRTOS task system.
		\end{itemize}
		%Antes de cambios o mierdas, miniintroduccion del freeRTOS y referencía a su capitulo

		%Pequeños cambios en FreeRTOS para soportar la nueva plataforma 6638
		Before to start the real objetive of this milestone we need to adapt the FreeRTOS main functionalities to the new MSP430, that been a new device was not actualy supported by. This mind the creation of a good number of new clases, most of them was excatly equal to their homonimes for the MSP430 5438A but other needs some little modifications.

		%Adaptación de la API para hacerla funcionar en un SO basado en tareas como es el FreeRTOS
		%Importantes riesgos de conflictos a nivel de compartición de recursos hardware, que con cuidado(más con suerte que con cuidado) pudieron ser esquivados.
		The next need in the milestone was port as soon as posible the TI USB API to a task-based SO like FreeRTOS whithout taking too much care about its correction. The introduction into the FreeRTOS was prety problematic because the size of just the the API was near to the size of the FreeRTOS. Plus, there are a very important risk, USB uses a important number of resources as pines or clock that can be also used by the FreeRTOS to another task, specially risky was the clock because both need a clock, but the selected board have 2 clock spots, and taking care in the port all this themes could resolved and everything works fine.\\

		%Estaba hecho pero mal, había inclusiones puestas donde no se debía y ya no se podía ejecutar ese mismo código en el shimmer o el antiguo MSP430.
		Once it's done our preocupation was how to order all this files in a correct way, because our free RTOS was a multiplatform SO that must work in MSP430 5438A, Shimmer, and now, the new MSP430 6638 where take place this develope. In the first port where the multiplatform ability of FreeRTOS was not a problem we lost this funcionality. This separation of tasks help pretty much in focus the first steps in this milestone. This new functionality have to be included just in the supported platform, the MSP430 6638, without affect the other ones as before. Using the preciding generalization needed to cohexists Shimmer and MSP430 5438A as a guide this port was not too traumatic.

		
		\subsection{802.15.4 in FreeRTOS}
		This milestone's objectives are:
		\begin{itemize}
		\item Validate current implementation of 802.15.4 in FreeRTOS in testing MSP430,
		\item manage connection to the CC2420 radio module to target MSP430 device,
		\item port implementation of 802.15.4 to target MSP430 device, and
		\item prepare such implementation for actual usage.
		\end{itemize}
		%Radio probada en una placa que no proveía USB pero sí salida por puerto serie para simplificar trabajo y facilitar la depuración, se llevó luego a otra con USB pero sin soporte ni software ni hardware para la radio, obligando a mapeo manual de 				pines, que ahora si con más mañana que suerte se hizo bien y no dio conflicto como veremos ahora aunque si hubo que modificar algo más de código dado que la nueva placa necesitaba iniciar los pines de la radio de otra forma.
		%FreeRTOS, parte radio en desarrollo por parte de terceros: trabajo incluyó buscar fallos, arreglarlos, terminar lo inacabado y aplicarlo al objetivo; en colaboración con el autor de FreeRTOS 

		\subsection{802.15.4 \& USB coexistence under FreeRTOS}
		This milestone's objectives are:
		\begin{itemize}
		\item Assess conflict-free coexistence of current implementation of both USB and 802.15.4 modules in MSP430,
		\item manage sending data received from 802.15.4 via USB.
		\end{itemize}
		%Riesgos de conflicto hardware entre Radio y USB
		%Riesgos de conflicto software entre Radio y USB sobre FreeRTOs
			%(Falta de tiempo para enviar y recibir)
		%Darle mucho peso a los riesgos y ver como tratar el tema de que no hubo prácticamente ningún problema con ellos(solo al de tiempo para enviar y recibir) sin que se note que este punto no tuvo mucho peso

		\subsection{Final aplication develop}
		\begin{itemize}
		\item Obtention of a shimmer final aplication
		\item Obtention of a Android aplication
		\item Test the whole system in its real use.
		\end{itemize}
		%Sabiamos que funcionaba con nuestros ejemplos pero faltaba comprobar si funcionaría con la aplicación objetivo del shimmer que tenía unas restricciones de envío más altas y como no podía ser de otra forma no funcionó. Nos agobiamos, rafa se temió lo peor, el shimmer enviaba mal, el tablet parseaba mal, pero nada de esto resolvía los problemas y al final tuvimos suerte y se arregló.

		\subsection{MSP430 based device design}
		\begin{itemize}
		\item Board exhaustive analysis
		\item Capture of the schematic
		\item PCB design and route
		\end{itemize}
		%Algo en plan, finalizada la investigación y gracias a que pusimos mucho empeño en acabar con tiempo suficiente fuimos capaces(como de tener la capacidad, no de conseguir(be able to)) de diseñar un dispositivo a partir de los componentes presentes en la placa de prototipado.
		%Identificación de componentes de placa 
			%(pines de expansión)
			%(cambio de componentes por otros)
			%(eliminacion JTAG y reutilizacion Radio)
		%Captura de esquemático
		%Diseño PCB
		%Rutado PCB

		\subsection{Final Validation and Release Candidate Version Development}
		%Esteeee si, mencinamos que esta milestone existía porque había que hacer las pruebas pertinentes ahora que todo estaba completo y comentamos lo que sea que vaya a pasar cuando esté todo.

		\section{Final Product}
		%Descripción de que es lo que hemos conseguido(es posible que con la evolución alguien que se lea las iteraciones no consiga una clara visión de cual es el estado final del dispositivo, por lo que esta parte me parece muy importante)
		%Tener cuidado de que no haya algo muy parecido en la parte de la introducción, aunque si debiera un miniresumen del producto, lo que de la conclusión debería incluir tambien posibles usos no contemplados de lo que hemos conseguido.
